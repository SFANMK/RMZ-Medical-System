
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة RMZ الطبية</title>

    <!-- Google Fonts (Cairo, Tajawal, Almarai) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;700&family=Almarai:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        :root {
            /* Default Theme: Medical Clean */
            --primary-color: #0EA5E9;
            --sidebar-bg: #FFFFFF;
            --app-bg: #F9FAFB;
            --card-bg: #FFFFFF;
            --text-dark: #111827;
            --text-gray: #6B7280;
            --border-color: #E5E7EB;
            --font-family: 'Cairo', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--app-bg);
            color: var(--text-dark);
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        #wrapper { display: flex; }
        
        #sidebar {
            width: 240px; min-height: 100vh;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            position: fixed; right: 0; top: 0; bottom: 0;
            z-index: 1000; transition: all 0.3s; padding: 1rem;
        }
        #sidebar .sidebar-brand {
            display: flex; align-items: center; justify-content: center;
            height: 5rem; font-size: 1.75rem; font-weight: 700;
        }
        #sidebar .sidebar-brand-logo { max-height: 40px; width: auto; }
        #sidebar .sidebar-brand-icon { color: var(--primary-color); }
        
        #sidebar .nav-item .nav-link {
            color: var(--text-gray); padding: 0.85rem 1rem;
            margin-bottom: 0.25rem; border-radius: 8px;
            font-weight: 500; transition: all 0.2s ease-in-out;
        }
        #sidebar .nav-item .nav-link:hover { color: var(--primary-color); background-color: rgba(14, 165, 233, 0.1); }
        #sidebar .nav-item.active .nav-link { color: var(--primary-color); background-color: rgba(14, 165, 233, 0.15); font-weight: 600; }
        #sidebar .nav-item .nav-link i { width: 20px; text-align: center; margin-left: 0.75rem; }

        #content-wrapper { width: 100%; padding-right: 240px; }
        #topbar { background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); height: 5rem; padding: 0 2rem; }
        .page-header { font-size: 1.875rem; font-weight: 700; color: var(--text-dark); }
        .container-fluid { padding: 2rem; }
        .view-container { display: none; animation: fadeIn 0.4s; }
        .view-container.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }
        .card-header {
            background-color: transparent; border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem; font-weight: 600;
            font-size: 1.125rem; color: var(--text-dark);
        }
        .card-body { padding: 1.5rem; }

        .login-view { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        #loading-spinner {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8); z-index: 1050;
            display: flex; justify-content: center; align-items: center;
        }
        #loading-spinner .spinner-border { color: var(--primary-color); }

        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { filter: brightness(90%); border-color: var(--primary-color); }
        .btn-outline-primary { color: var(--primary-color); border-color: var(--primary-color); }
        .btn-outline-primary:hover { color: #fff; background-color: var(--primary-color); }

        /* Theme: Modern Glass */
        body.theme-glass {
            background-image: linear-gradient(to top right, #0284C7, #3B82F6);
        }
        .theme-glass #sidebar, .theme-glass .card, .theme-glass #topbar {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        .theme-glass .page-header, .theme-glass #sidebar .nav-item .nav-link, .theme-glass .card, .theme-glass #topbar, .theme-glass .text-dark, .theme-glass .card-header {
            color: #FFFFFF;
        }
         .theme-glass #sidebar .nav-item .nav-link:hover { color: #FFFFFF; background-color: rgba(255, 255, 255, 0.2); }
         .theme-glass #sidebar .nav-item.active .nav-link { background-color: rgba(255, 255, 255, 0.3); }

        /* Theme: Corporate Dark */
        body.theme-dark {
            --app-bg: #111827;
            --sidebar-bg: #1F2937;
            --card-bg: #1F2937;
            --border-color: #374151;
            --text-dark: #F9FAFB;
            --text-gray: #9CA3AF;
        }
        .theme-dark #sidebar .nav-item .nav-link:hover { background-color: #374151; }
        .theme-dark #sidebar .nav-item.active .nav-link { background-color: #4B5563; }
        .theme-dark #loading-spinner { background-color: rgba(17, 24, 39, 0.8); }

    </style>
</head>
<body>
    <div id="login-view" class="view-container active login-view">
         <div class="col-xl-4 col-lg-5 col-md-7">
            <div class="card">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <span class="sidebar-brand-icon fs-1"><i class="fas fa-heart-pulse"></i></span>
                        <h1 class="h4 text-dark mt-3 mb-4">تسجيل الدخول إلى النظام</h1>
                    </div>
                    <form id="login-form">
                        <div class="mb-3"><label class="form-label">اسم المستخدم</label><input type="text" class="form-control" name="username" required></div>
                        <div class="mb-3"><label class="form-label">كلمة المرور</label><input type="password" class="form-control" name="password" required></div>
                        <div class="d-grid mt-4"><button type="submit" class="btn btn-primary btn-lg">دخول</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="wrapper" style="display: none;">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                 <img src="" id="sidebar-logo" class="sidebar-brand-logo d-none" alt="Logo">
                 <span id="sidebar-icon-fallback" class="sidebar-brand-icon"><i class="fas fa-heart-pulse"></i></span>
                 <span id="sidebar-text-fallback" class="ms-2">RMZ</span>
            </div>
            <ul class="nav flex-column mt-4">
                <li class="nav-item active" data-view="dashboard"><a class="nav-link" href="#"><i class="fas fa-fw fa-tachometer-alt"></i><span>لوحة التحكم</span></a></li>
                <li class="nav-item" data-view="service-builder" data-role="Admin"><a class="nav-link" href="#"><i class="fas fa-fw fa-cogs"></i><span>منشئ الخدمات</span></a></li>
                <li class="nav-item" data-view="requests"><a class="nav-link" href="#"><i class="fas fa-fw fa-folder"></i><span id="requests-nav-label">الطلبات</span></a></li>
                <li class="nav-item" data-view="system-settings" data-role="Admin"><a class="nav-link" href="#"><i class="fas fa-fw fa-palette"></i><span>إعدادات النظام</span></a></li>
            </ul>
        </nav>
        <div id="content-wrapper">
            <header id="topbar" class="d-flex align-items-center">
                <ul class="navbar-nav ms-auto"><li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <img class="rounded-circle me-2" height="32" width="32" src="https://via.placeholder.com/60/0EA5E9/ffffff?text=U">
                        <span class="d-none d-lg-inline text-dark" id="username-display"></span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow"><a class="dropdown-item" href="#" id="logout-btn"><i class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>تسجيل الخروج</a></div>
                </li></ul>
            </header>
            <main class="container-fluid">
                <div id="dashboard-view" class="view-container"></div>
                <div id="service-builder-view" class="view-container" data-role="Admin"></div>
                <div id="requests-view" class="view-container"></div>
                <div id="system-settings-view" class="view-container" data-role="Admin"></div>
                <div id="dynamic-form-view" class="view-container"></div>
            </main>
        </div>
    </div>
    <div id="loading-spinner" class="d-none"><div class="spinner-border" style="width: 3rem; height: 3rem;"></div></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyARaqwoOcE84yriFdLoboxYooW3wAZrl5k",
            authDomain: "rmz-medical-system.firebaseapp.com",
            projectId: "rmz-medical-system",
            storageBucket: "rmz-medical-system.firebasestorage.app",
            messagingSenderId: "143767952272",
            appId: "1:143767952272:web:e2c3a19058a08c72097115"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        let currentUser = null;
        let unsubscribeListeners = [];
        let systemSettings = {};

        const loadingSpinner = document.getElementById('loading-spinner');
        const views = document.querySelectorAll('.view-container');
        
        const showLoading = (show) => loadingSpinner.classList.toggle('d-none', !show);
        const showAlert = (title, text, icon = 'success') => Swal.fire({ title, text, icon, confirmButtonText: 'حسنًا' });
        const slugify = (text) => text.toString().toLowerCase().replace(/\s+/g, '_').replace(/[^\w-]+/g, '');

        const applyTheme = (settings) => {
            const root = document.documentElement;
            root.style.setProperty('--primary-color', settings.primaryColor || '#0EA5E9');
            document.body.className = settings.themeClass || '';
            document.body.style.fontFamily = settings.fontFamily || "'Cairo', sans-serif";
            
            const logoEl = document.getElementById('sidebar-logo');
            const iconFallback = document.getElementById('sidebar-icon-fallback');
            const textFallback = document.getElementById('sidebar-text-fallback');

            if (settings.logoUrl) {
                logoEl.src = settings.logoUrl;
                logoEl.classList.remove('d-none');
                iconFallback.classList.add('d-none');
                textFallback.classList.add('d-none');
            } else {
                logoEl.classList.add('d-none');
                iconFallback.classList.remove('d-none');
                textFallback.classList.remove('d-none');
            }
        };

        const showView = (viewId) => {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(`${viewId}-view`).classList.add('active');
            document.querySelectorAll('#sidebar .nav-item').forEach(item => item.classList.toggle('active', item.dataset.view === viewId));
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            const renderMap = {
                'dashboard': currentUser.role === 'Admin' ? renderAdminDashboard : renderUserDashboard,
                'requests': currentUser.role === 'Admin' ? renderAdminRequests : renderUserRequests,
                'service-builder': renderServiceBuilder,
                'system-settings': renderSystemSettings
            };
            renderMap[viewId]?.();
        };

        const performLogin = (username, role) => {
            currentUser = { username, role };
            sessionStorage.setItem('rmzUser', JSON.stringify(currentUser));
            initializeAppUI();
        };

        const handleLogin = (e) => {
            e.preventDefault();
            const { username, password } = Object.fromEntries(new FormData(e.target));
            if (username === 'admin' && password === 'admin123') performLogin('admin', 'Admin');
            else if (username === 'user' && password === '123456') performLogin('user', 'Beneficiary');
            else showAlert('خطأ', 'بيانات الاعتماد غير صحيحة', 'error');
        };
        
        const handleLogout = () => {
            currentUser = null;
            sessionStorage.removeItem('rmzUser');
            document.getElementById('wrapper').style.display = 'none';
            document.getElementById('login-view').classList.add('active');
        };

        // --- ALL OTHER RENDER FUNCTIONS (dashboard, requests, etc.) remain the same ---
        // They will automatically inherit the new styles from the theme engine.
        // For brevity, only new or significantly modified functions are detailed.

        const renderSystemSettings = () => {
            const view = document.getElementById('system-settings-view');
            view.innerHTML = `<h1 class="page-header mb-4">إعدادات النظام</h1>
            <div class="card"><div class="card-header">تخصيص الهوية البصرية</div><div class="card-body">
            <form id="settings-form">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">السمة الرئيسية</label>
                        <select id="theme-selector" class="form-select">
                            <option value="">طبي ونظيف (افتراضي)</option>
                            <option value="theme-glass">زجاجي حديث</option>
                            <option value="theme-dark">داكن للشركات</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">الخط الأساسي</label>
                        <select id="font-selector" class="form-select">
                            <option value="'Cairo', sans-serif">Cairo</option>
                            <option value="'Tajawal', sans-serif">Tajawal</option>
                            <option value="'Almarai', sans-serif">Almarai</option>
                        </select>
                    </div>
                </div>
                <div class="row align-items-center">
                    <div class="col-md-6 mb-3">
                        <label for="primary-color-picker" class="form-label">اللون الأساسي للعلامة التجارية</label>
                        <input type="color" id="primary-color-picker" class="form-control form-control-color" value="${systemSettings.primaryColor || '#0EA5E9'}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="logo-upload" class="form-label">رفع شعار جديد</label>
                        <input type="file" id="logo-upload" class="form-control" accept="image/*">
                        <img id="logo-preview" src="${systemSettings.logoUrl || ''}" class="mt-2" style="max-height: 40px; ${systemSettings.logoUrl ? '' : 'display:none;'}">
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">حفظ الإعدادات</button></div>
            </form>
            </div></div>`;
            
            // Populate form with current settings
            document.getElementById('theme-selector').value = systemSettings.themeClass || '';
            document.getElementById('font-selector').value = systemSettings.fontFamily || "'Cairo', sans-serif";
            
            // Live preview listeners
            document.getElementById('theme-selector').addEventListener('change', (e) => document.body.className = e.target.value);
            document.getElementById('font-selector').addEventListener('change', (e) => document.body.style.fontFamily = e.target.value);
            document.getElementById('primary-color-picker').addEventListener('input', (e) => document.documentElement.style.setProperty('--primary-color', e.target.value));
            document.getElementById('logo-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('logo-preview').src = event.target.result;
                        document.getElementById('logo-preview').style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });
        };

        const handleSaveSettings = async (e) => {
            e.preventDefault();
            showLoading(true);

            let newLogoUrl = systemSettings.logoUrl;
            const logoFile = document.getElementById('logo-upload').files[0];

            try {
                if (logoFile) {
                    const storageRef = storage.ref(`logos/${Date.now()}_${logoFile.name}`);
                    const snapshot = await storageRef.put(logoFile);
                    newLogoUrl = await snapshot.ref.getDownloadURL();
                }

                const newSettings = {
                    themeClass: document.getElementById('theme-selector').value,
                    fontFamily: document.getElementById('font-selector').value,
                    primaryColor: document.getElementById('primary-color-picker').value,
                    logoUrl: newLogoUrl || ''
                };
                
                await db.collection('system_settings').doc('config').set(newSettings, { merge: true });
                systemSettings = newSettings;
                applyTheme(systemSettings);
                showAlert('نجاح', 'تم حفظ إعدادات النظام بنجاح.');

            } catch (err) {
                console.error("Error saving settings:", err);
                showAlert('خطأ', 'فشل حفظ الإعدادات.', 'error');
            } finally {
                showLoading(false);
            }
        };

        const initializeAppUI = () => {
            document.getElementById('login-view').classList.remove('active');
            document.getElementById('wrapper').style.display = 'flex';
            document.getElementById('username-display').textContent = currentUser.username;
            document.querySelectorAll('[data-role]').forEach(el => el.style.display = el.dataset.role === currentUser.role ? 'block' : 'none');
            document.getElementById('requests-nav-label').textContent = currentUser.role === 'Admin' ? 'إدارة الطلبات' : 'طلباتي';
            showView('dashboard');
        };

        // --- Main App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading(true);
            try {
                const settingsDoc = await db.collection('system_settings').doc('config').get();
                if (settingsDoc.exists) {
                    systemSettings = settingsDoc.data();
                } else {
                    // Default settings if nothing in DB
                    systemSettings = { primaryColor: '#0EA5E9', themeClass: '', fontFamily: "'Cairo', sans-serif", logoUrl: '' };
                }
                applyTheme(systemSettings);

                const storedUser = sessionStorage.getItem('rmzUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    initializeAppUI();
                }
            } catch (err) {
                console.error("Failed to initialize app settings:", err);
                applyTheme({ primaryColor: '#0EA5E9', themeClass: '', fontFamily: "'Cairo', sans-serif", logoUrl: '' });
            } finally {
                showLoading(false);
            }

            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.querySelectorAll('#sidebar .nav-item').forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); showView(item.dataset.view); }));
            
            document.body.addEventListener('click', (e) => {
                if (e.target.id === 'add-field-btn') handleAddField();
                if (e.target.id === 'back-to-dashboard') showView('dashboard');
                const applyBtn = e.target.closest('.apply-btn');
                if (applyBtn) renderDynamicForm(applyBtn.dataset.id);
                const viewDetailsBtn = e.target.closest('.view-submission-btn');
                if (viewDetailsBtn) viewSubmissionDetails(viewDetailsBtn.dataset.id);
            });
            document.body.addEventListener('submit', (e) => {
                if(e.target.id === 'service-builder-form') handleSaveService(e);
                if(e.target.id === 'dynamic-form') handleFormSubmission(e);
                if(e.target.id === 'settings-form') handleSaveSettings(e);
            });
        });
        
        // --- Dummy render functions to keep the app working ---
        const renderAdminDashboard = () => document.getElementById('dashboard-view').innerHTML = `<h1 class="page-header mb-4">لوحة التحكم</h1><p>مرحباً أيها المدير!</p>`;
        const renderUserDashboard = () => document.getElementById('dashboard-view').innerHTML = `<h1 class="page-header mb-4">الخدمات المتاحة</h1><p>مرحباً بك!</p>`;
        const renderAdminRequests = () => document.getElementById('requests-view').innerHTML = `<h1 class="page-header mb-4">إدارة الطلبات</h1>`;
        const renderUserRequests = () => document.getElementById('requests-view').innerHTML = `<h1 class="page-header mb-4">طلباتي</h1>`;
        const renderServiceBuilder = () => document.getElementById('service-builder-view').innerHTML = `<h1 class="page-header mb-4">منشئ الخدمات</h1>`;
        const renderDynamicForm = () => document.getElementById('dynamic-form-view').innerHTML = `<h1 class="page-header mb-4">تقديم طلب</h1>`;
        const handleSaveService = () => showAlert('تنبيه', 'وظيفة لم تكتمل بعد');
        const handleFormSubmission = () => showAlert('تنبيه', 'وظيفة لم تكتمل بعد');
        const viewSubmissionDetails = () => showAlert('تنبيه', 'وظيفة لم تكتمل بعد');
        const handleAddField = () => {};


    </script>
</body>
</html>
